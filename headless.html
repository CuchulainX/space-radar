<html>
<head>
  <title>DU headless</title>
</head>
<body>
  <script src="js/utils.js"></script>
  <script>

  'use strict';

  const path = require('path')
  const du = require('./js/du')

  const ipc = require('ipc')
  const ipc_name = 'du'
  const fs = require('fs')

  // ipc.send('register', ipc_name)

  // ipc.on('ready', function() {
  //   console.log('all is ready')
  //   // go();
  //   setTimeout(go, 2000)
  // })

  // ipc.on('broadcast', function(arg) {
  //   console.log('[' + ipc_name + '] broadcast', arg)
  // })

  // ipc.on('message', function(arg) {
  //   console.log('[' + ipc_name + '] message', arg)
  // })

  ipc.on('scan', function(target) {
    console.log('got scan')
    go(target)
  })

  function go(target) {
    let
      START_REFRESH_INTERVAL = 5000,
      REFRESH_INTERVAL = START_REFRESH_INTERVAL,
      MAX_REFRESH_INTERVAL = 15 * 60 * 1000

    let json = {}
    let refreshTask = new TimeoutTask(function(next) {
      log('refresh...')
      transfer('refresh', json)
      REFRESH_INTERVAL *= 3
      next(Math.min(REFRESH_INTERVAL, MAX_REFRESH_INTERVAL))
    }, REFRESH_INTERVAL)

    console.time('async2')

    function complete(counter) {
        // console.log("Scan completed", counter, "files");
        console.timeEnd('async2')
        refreshTask.cancel()

        console.log(json);
        transfer('complete', json)
        console.log('ok')

        // cleanup
        json = {}
        du.resetCounters()
        gc()

        // // cache
        // console.time('write')
        // fs.writeFileSync('test.json', JSON.stringify(json))
        // console.timeEnd('write')
    };

    function progress(path, name, size) {
      transfer('progress', path, name, size)
    }

    target = path.resolve(target)
    console.log('Scanning target', target)

    du({
        parent: target,
        node: json,
        onprogress: progress,
        // onrefresh: refresh
      }, complete)

    refreshTask.schedule()

    // // for testing purposes only
    // console.log('moew')
    // json = fs.readFileSync('experiments/root.json', { encoding: 'utf-8'})
    // console.log(json.length)
    // transfer('complete', JSON.parse(json))

  }

  function transfer(target) {
    var args = Array.prototype.slice.call(arguments)

    var jsonstr = JSON.stringify(args)

    // webview IPC

    var err;
    try {
      // localStorage IPC
      localStorage.lsipc = jsonstr
    } catch (e) {
      console.error('fail: ')
       console.log('len', jsonstr.length)
      err = e;
    }

    if (err) {
      err = null
      let p = path.join(__dirname, 'fs-ipc.json')
      fs.writeFileSync(p, jsonstr, { encoding: 'utf-8' })
      transfer('fs-ipc', p)
      return
    }

    if (err) {
      err = null
      try {
        // web view ipc
        ipc.sendToHost.apply(ipc, args)
      } catch (e) {
        err = e
        console.error(e)
      }
    }

    if (err) {
      err = null
      try {
        // fallback to electron browser IPC
        args.unshift('call', 'viz')
        ipc.send.apply(ipc, args)
      } catch (e) {
        err = e
        console.error(e)
      }
    }
  }


  </script>
</body>
</html>