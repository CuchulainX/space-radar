<html>
<head>
  <title>DU headless</title>
</head>
<body>
  <script>

  'use strict';

  const path = require('path')
  const du = require('./js/du')

  const ipc = require('ipc')
  const ipc_name = 'du'

  // ipc.send('register', ipc_name)

  // ipc.on('ready', function() {
  //   console.log('all is ready')
  //   // go();
  //   setTimeout(go, 2000)
  // })

  // ipc.on('broadcast', function(arg) {
  //   console.log('[' + ipc_name + '] broadcast', arg)
  // })

  // ipc.on('message', function(arg) {
  //   console.log('[' + ipc_name + '] message', arg)
  // })

  ipc.on('scan', function(target) {
    console.log('got scan')
    go(target)
  })

  function go(target) {

    // let target = '../../..'
    var INCREMENTAL_INTERVAL = 30000

    let checker
    let json = {}
    console.time('async2')

    function complete(counter) {
        // console.log("Scan completed", counter, "files");
        console.timeEnd('async2')
        clearTimeout(checker)

        console.log(json);
        transfer('complete', json)
        console.log('ok')

        // cache
        // console.time('write')
        // require('fs').writeFileSync('test.json', JSON.stringify(json))
        // console.timeEnd('write')
    };

    function refresh() {
      clearTimeout(checker)
      console.log('refresh...');
      transfer('refresh', json)
      checker = setTimeout(refresh, INCREMENTAL_INTERVAL)
    }

    function progress(path, name) {
      transfer('progress', path, name)
    }

    target = path.resolve(target)
    console.log('Scanning target', target)

    // TODO use IPC call for this
    du({
        parent: target,
        node: json,
        onprogress: progress,
        // onrefresh: refresh
      }, complete)

    // // for testing purposes only
    // console.log('moew')
    // json = require('fs').readFileSync('experiments/root.json', { encoding: 'utf-8'})
    // console.log(json.length)
    // transfer('complete', JSON.parse(json))

    // console.time('parse')
    // json = JSON.parse(json)
    // console.timeEnd('parse')


    // transfer('complete', JSON.parse(json))

    // console.log('boo')

    // setTimeout(refresh, 5000)

  }

  function transfer(target) {
    var args = Array.prototype.slice.call(arguments)

    var jsonstr = JSON.stringify(args)
    console.log('len', jsonstr.length)
    // webview IPC
    try {
      // localStorage IPC
      localStorage.lsipc = jsonstr
    } catch (e) {
      console.error('fail: ')


      try {
        ipc.sendToHost.apply(ipc, args)
      } catch (e) {
        console.error(e)
      }

      return

      // fallback to electron browser IPC
      args.unshift('call', 'viz')
      ipc.send.apply(ipc, args)
    }
  }


  </script>
</body>
</html>