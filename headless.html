<html>
<head>
  <title>DU headless</title>
</head>
<body>
  <script>

  'use strict';

  const path = require('path')
  const ipc = require('ipc')
  const du = require('./js/du')

  const ipc_name = 'du'
  ipc.send('register', ipc_name)

  ipc.on('ready', function() {
    console.log('all is ready')
    go();
  })

  ipc.on('broadcast', function(arg) {
    console.log('[' + ipc_name + '] broadcast', arg)
  })

  ipc.on('message', function(arg) {
    console.log('[' + ipc_name + '] message', arg)
  })

  function go() {

    let target = '../../..'
    var INCREMENTAL_INTERVAL = 30000

    let checker
    let json = {}
    console.time('async2')

    function complete(counter) {
        // console.log("Scan completed", counter, "files");
        console.timeEnd('async2')
        clearTimeout(checker)

        console.log(json);

        // cache
        // console.time('write')
        // require('fs').writeFileSync('test.json', JSON.stringify(json))
        // console.timeEnd('write')

        setTimeout( () =>
          transfer('complete', null)
        )
    };

    function refresh() {
      clearTimeout(checker)
      console.log('scanning...');
      transfer('refresh', null) // json

      checker = setTimeout(refresh, INCREMENTAL_INTERVAL)
    }

    function progress(path, name) {
      transfer('progress', path, name)
    }


    target = path.resolve(target)
    console.log('Scanning target', target)

    let buffer = []

    // TODO use IPC call for this
    du({
        parent: target,
        node: json,
        onprogress: progress,
        onfile: function(path, name, size) {
          buffer.push([path, name, size])
          if (buffer.length == 10000) {
            transfer('files', buffer)
            buffer = []
          }

        },
        // onrefresh: refresh
      }, complete)

    // // for testing purposes only
    // console.log('moew')
    // json = require('fs').readFileSync('experiments/root.json', { encoding: 'utf-8'})
    // console.log(json.length)
    // transfer('complete', JSON.parse(json))
    // console.log('boo')

    setTimeout(refresh, 5000)

  }

  function transfer(target) {
    var args = Array.prototype.slice.call(arguments)

    var str=  JSON.stringify(args)

    try {
      // localStorage IPC
      localStorage.lsipc = str;
    } catch (e) {


      // webview IPC
      console.error('fail ' + str.length)
      ipc.sendToHost.apply(ipc, args)
      return



      console.log(args[1].length)
      // fallback to electron browser IPC
      args.unshift('call', 'viz')
      ipc.send.apply(ipc, args)
    }
  }


  // onJson(null, JSON.parse(json).children[10])
  // onJson(null, JSON.parse(json))


  </script>
  <script>

  // ipc.on('args', function (args) {
  //   console.log('yoz i got something!!!')
  //   // var app
  //   // if (path.isAbsolute(args[2])) {
  //   //   app = require(args[2])
  //   // } else {
  //   //   app = require(path.join(process.cwd(), args[2]))
  //   // }
  //   // if (typeof app === 'function') app(args.slice(2))
  // })
  </script>
</body>
</html>