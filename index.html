<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <title>Space Radar</title>
</head>
<body>
<script src="node_modules/d3/d3.js"></script>
<link rel="stylesheet" href="css/style.css" type="text/css">
<link rel="stylesheet" href="css/throbber.css" type="text/css">
<link rel="stylesheet" href="css/breadcrumb.css" type="text/css">

<webview id="foo" src="headless.html" style="display:inline-block; width:240px; height:280px" nodeintegration="on"></webview>

<div id="loading">
  <div class="throbber-loader">
    Loadingâ€¦
  </div>
</div>

<div id="sequence">
  <div class="breadcrumb flat">
  </div>
</div>

<div id="legend"></div>

<div id="explanation">
  <span id="core_top">Loading...</span><br/>
  <span id="core_center"></span><br/>
  <span id="core_tag"></span>
</div>

<script src="js/utils.js"></script>
<!-- <script src="js/du.js"></script> -->
<script src="js/bipartition_sunburst.js"></script>
<!-- <script src="js/treemap.js"></script> -->

<script>

var ipc = require('ipc')

const ipc_name = 'viz'
ipc.send('register', ipc_name)

ipc.on('message', function(arg) {
  console.log('[' + ipc_name + '] message', arg)
})

ipc.on('ready', function(arg) {
  console.log('lets go');
  loading.style.display = 'inline-block'
})

// ipc listeners
ipc.on('progress', progress)
ipc.on('refresh', refresh)
ipc.on('complete', complete)

function progress(dir, name) {
  // console.log('[' + ipc_name + '] progress', name)
  // onProcess(dir, name)
}

function refresh(json) {
  console.log('[' + ipc_name + '] refresh..')
  onJson(null, json)
}

console.time('zzzzz')
function complete(json) {
  console.timeEnd('zzzzz')
  loading.style.display = 'none'
  console.log('[' + ipc_name + '] complete..', json)
  // onJson(null, json)
  onJson(null, clone2(fs))
}


var fs = {
  name: 'root',
  children: []
};

var c = 0;

function files(buff) {
  console.time('file')
  buff.forEach(b => {
    file(b[0], b[1], b[2])
  })
  console.timeEnd('file')
  // refresh(clone2(fs))
}
function file(dir, name, size) {
    c++;
  if (c % 200000 == 0) {
    refresh(clone2(fs))
  }

  var node = fs;
  var paths = dir.split('/').slice(1, -1).forEach(path => {
    var x = node.children.filter( x => {
      return x.name == path
    })

    if (x.length) {
      node = x[0]
    } else {
      var tmp = { name: path, children: [] }
      node.children.push(tmp)
      node = tmp
    }
  })

  node.children.push({
    name: name,
    size: size
  })


}

legend.innerHTML  = "<h2>MOOOOOOOOO</h2>"

function onProcess(path, b) {
  legend.innerHTML("<h2>scanning: "+b+"</h2><p>"+path+"</p>")
}

const DEBUG = 0

// var remote = require('remote')
// var BrowserWindow = remote.require('browser-window')
// var win = new BrowserWindow(
//   DEBUG ? { width: 800, height: 600 } : { show: false }
// )
// win.loadUrl('file://' + __dirname + '/headless.html');
// if (DEBUG) win.openDevTools()
// //
// win.webContents.on('did-finish-load', function() {
//   // win.webContents.send('ready')
// })

window.addEventListener('storage', function (e) {
 if (e.key == 'lsipc') {
  var args = JSON.parse(e.newValue)
  var cmd = args.shift()
  handleIPC(cmd, args)
 }
});

// dom-ready
foo.addEventListener("did-finish-load", function() {
  foo.openDevTools();
});

foo.addEventListener('ipc-message', function(event) {
  var args = event.args
  var cmd = event.channel
  handleIPC(cmd, args)
  // console.log(event.channel, event);
  // Prints "pong"
});

function handleIPC(cmd, args) {
  switch (cmd) {
    case 'progress':
      return progress.apply(null, args)
    case 'refresh':
      return refresh.apply(null, args)
    case 'complete':
      return complete(args[0])
    case 'files':
      return files.apply(null, args)
  }
}

// foo.send('ping');

// // testing
// d3.json("mem.json", function(x, y) {
//   console.log(x, y)
//   window.j = y
//   setTimeout(() => complete(y))

// });



</script>

</body>
</html>
